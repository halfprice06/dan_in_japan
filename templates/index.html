<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dan In Japan</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 3rem;
            padding-right: 3rem;
        }

        .modal-content {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: zoom-in;
            margin-bottom: 100px;
        }

        .modal-content.info-hidden {
            margin-bottom: 0;
            max-height: 95vh;
        }

        .modal-content.zoomed {
            cursor: zoom-out;
            max-width: none;
            max-height: none;
            margin-bottom: 0;
        }

        .modal-info {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 1rem;
            text-align: center;
            opacity: 1;
            transition: all 0.5s ease;
            z-index: 1001;
        }

        .modal-info.hidden {
            transform: translateY(100%);
        }

        .modal-info h2 {
            font-size: 1.25rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
            font-weight: 500;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .modal-info .text-gray-300 {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            color: white;
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1001;
            padding: 0.5rem;
            line-height: 1;
            transition: transform 0.2s ease;
        }

        .modal-close:hover {
            transform: scale(1.1);
        }

        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 2.5rem;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1002;
        }

        .modal:hover .modal-nav {
            opacity: 0.8;
        }

        .modal-nav:hover {
            opacity: 1 !important;
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .modal-prev {
            left: 1rem;
        }

        .modal-next {
            right: 1rem;
        }

        @media (max-width: 768px) {
            .modal-nav {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }

            .modal-prev {
                left: 0.5rem;
            }

            .modal-next {
                right: 0.5rem;
            }
        }

        /* Make sure buttons are visible on mobile */
        @media (hover: none) {
            .modal-nav {
                opacity: 0.8;
            }
        }

        .photo-card {
            @apply transition-all duration-300 hover:shadow-2xl;
        }

        .photo-card img {
            @apply transition-all duration-500;
        }

        .photo-card:hover img {
            @apply transform scale-105;
        }

        /* Add smooth loading animation */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading spinner */
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.17, 0.67, 0.83, 0.67) infinite;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Image counter */
        .image-counter {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
        }

        /* Touch feedback for mobile */
        @media (hover: none) {
            .modal-nav {
                opacity: 0.8;
                background: rgba(0, 0, 0, 0.4);
            }

            .modal-nav:active {
                background: rgba(0, 0, 0, 0.8);
            }
        }

        /* Smooth loading animation for images */
        .gallery-image {
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhance hover effects */
        .group:hover {
            transform: translateY(-4px);
        }

        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            padding: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }

        .leaflet-popup-content {
            margin: 0;
            line-height: 1.4;
        }

        .leaflet-popup-tip-container {
            margin-top: -1px;
        }

        .leaflet-popup {
            margin-bottom: 20px;
        }

        /* Enhance cluster markers */
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
            background-color: rgba(66, 88, 255, 0.2);
        }

        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font-size: 12px;
            color: white;
            background-color: rgba(66, 88, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Add animation for popup opening */
        .leaflet-fade-anim .leaflet-popup {
            opacity: 0;
            transition: opacity 0.2s linear;
        }

        .leaflet-fade-anim .leaflet-map-pane .leaflet-popup {
            opacity: 1;
        }

        /* Line clamp for truncating text */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .featured-photo {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Add animation delay for each featured photo */
        .featured-photo:nth-child(1) { animation-delay: 0.2s; }
        .featured-photo:nth-child(2) { animation-delay: 0.4s; }
        .featured-photo:nth-child(3) { animation-delay: 0.6s; }

        /* Japanese-inspired styles */
        .prose a {
            text-decoration-thickness: 2px;
            text-underline-offset: 4px;
        }
        
        /* Remove the white gap */
        body {
            background-color: #f8f8f8;
            margin: 0;
            padding: 0;
        }
        
        .container {
            padding-top: 2rem;
        }
        
        /* Japanese pattern background */
        .bg-pattern {
            background-color: #f8f8f8;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='0.04' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Smooth transitions */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }

        /* Add toggle button for info panel */
        .modal-info-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1002;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-info-toggle:hover {
            background: rgba(0, 0, 0, 0.95);
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto py-8 px-4">
        <!-- Hero section with Japanese-inspired design -->
        <div class="relative mb-12 grid grid-cols-1 lg:grid-cols-2 gap-8 bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Left side - Hero image -->
            <div class="relative h-[300px] sm:h-[400px] lg:h-full min-h-[300px]">
                <div class="absolute inset-0 bg-cover bg-center transform hover:scale-105 transition-transform duration-700" 
                     style="background-image: url('{% if photos %}{{ '/static/photos/' + photos[0].file_path }}{% else %}/static/default-hero.jpg{% endif %}');">
                    <div class="absolute inset-0 bg-black bg-opacity-30"></div>
                </div>
                <!-- Japanese-style overlay pattern -->
                <div class="absolute inset-0 opacity-20 bg-repeat" 
                     style="background-image: url('data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E');">
                </div>
                <!-- Title with Japanese-inspired typography -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white tracking-wider text-center px-4" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        Dan in Japan
                        <span class="block text-base sm:text-lg mt-2 font-light tracking-widest">ダンイン ジャパン</span>
                    </h1>
                </div>
            </div>

            <!-- Right side - Description -->
            <div class="p-6 sm:p-8 lg:p-12 flex flex-col justify-center">
                <div class="prose prose-lg max-w-none">
                    <!-- Japanese-inspired decorative element -->
                    <div class="w-24 h-1 bg-red-600 mb-6 sm:mb-8"></div>
                    
                    <p class="text-base sm:text-lg leading-relaxed text-gray-700 mb-4 sm:mb-6">
                        In October 2024, I spent 2 weeks in Japan with my wife Christina and our good friends Chuck and Ashley. We visited Tokyo, Osaka, and Kyoto.
                    </p>
                    <p class="text-base sm:text-lg leading-relaxed text-gray-700 mb-4 sm:mb-6">
                        When we got back I decided I wanted to take everyone's photos and build an interactive photo gallery. I started brainstorming ideas with ChatGPT and Claude for how to make the site more interactive with AI.
                    </p>
                    <p class="text-base sm:text-lg leading-relaxed text-gray-700">
                        I decided to use AI to generate captions for all of the photos and to use the 
                        <a href="https://github.com/jxnl/instructor" class="text-red-600 hover:text-red-700 underline decoration-red-200 hover:decoration-red-600 transition-colors duration-200">instructor library</a> 
                        to extract "Points of Interest" from each photo and make them interactive with additional information also generated by AI. For more information on how the captions and points of interest were generated, <a href="https://daninjapan.net/about" class="text-red-600 hover:text-red-700 underline decoration-red-200 hover:decoration-red-600 transition-colors duration-200">click here</a>.
                        Check out the code on 
                        <a href="https://github.com/halfprice06/dan_in_japan" class="text-red-600 hover:text-red-700 underline decoration-red-200 hover:decoration-red-600 transition-colors duration-200">GitHub</a>.
                    </p>
                    
                    <!-- Japanese-inspired decorative element -->
                    <div class="w-24 h-1 bg-red-600 mt-6 sm:mt-8"></div>
                </div>
            </div>
        </div>

        <!-- Featured Photos section - now directly after the hero -->
        <div class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8 flex items-center justify-center">
                <span class="text-red-600 mx-4">〜</span>
                Random Photos
                <span class="text-red-600 mx-4">〜</span>
            </h2>
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for photo in featured_photos %}
                <div class="group bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="relative aspect-[4/3] overflow-hidden">
                        <img class="w-full h-full object-cover transform transition-transform duration-700 group-hover:scale-110" 
                             src="/static/photos/{{ photo.file_path }}" 
                             alt="{{ photo.caption }}"
                             loading="lazy"
                             onclick='openModal("/static/photos/{{ photo.file_path }}", {{ photo.caption|tojson }}, {{ photo.location_name|tojson }}, {{ photo.date_taken.strftime("%B %d, %Y")|tojson if photo.date_taken else "null" }})'
                        >
                        {% if photo.location_name %}
                        <div class="absolute top-4 left-4 bg-black bg-opacity-75 text-white px-3 py-1 rounded-full text-sm">
                            {{ photo.location_name }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-4">
                        <p class="text-gray-800 line-clamp-2">{{ photo.caption }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="text-center">
                <button onclick="scrollToGallery()" 
                        class="bg-indigo-600 text-white px-8 py-3 mt-8 rounded-full font-medium hover:bg-indigo-700 transition-colors duration-200 transform hover:scale-105">
                    View Full Gallery
                </button>
            </div>
        </div>

        <!-- Add Map section with heading -->
        <div class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8">Explore Our Journey</h2>
            <div id="map" class="w-full h-96 rounded-lg shadow-lg"></div>
        </div>

        <!-- After the map section, add this full gallery section -->
        <div class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8 flex items-center justify-center">
                <span class="text-red-600 mx-4">〜</span>
                Full Gallery
                <span class="text-red-600 mx-4">〜</span>
            </h2>
            
            <!-- Filter controls -->
            <div class="mb-8 flex flex-wrap gap-4 items-center justify-center bg-white p-4 rounded-lg shadow-md">
                <select id="locationFilter" 
                        class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        aria-label="Filter photos by location">
                    <option value="">All Locations</option>
                    {% for location in unique_locations %}
                    <option value="{{ location }}">{{ location }}</option>
                    {% endfor %}
                </select>
                
                <select id="sortOrder" 
                        class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        aria-label="Sort photos by">
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc" selected>Oldest First</option>
                    <option value="location">By Location</option>
                </select>
            </div>
            
            <!-- Full gallery grid -->
            <div id="fullGallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for photo in photos %}
                <div class="group bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="relative aspect-[4/3] overflow-hidden">
                        <img class="w-full h-full object-cover transform transition-transform duration-700 group-hover:scale-110" 
                             src="/static/photos/{{ photo.file_path }}" 
                             alt="{{ photo.caption }}"
                             loading="lazy"
                             onclick='openModal("/static/photos/{{ photo.file_path }}", {{ photo.caption|tojson }}, {{ photo.location_name|tojson }}, {{ photo.date_taken.strftime("%B %d, %Y")|tojson if photo.date_taken else "null" }})'
                        >
                        {% if photo.location_name %}
                        <div class="absolute top-4 left-4 bg-black bg-opacity-75 text-white px-3 py-1 rounded-full text-sm">
                            {{ photo.location_name }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-4">
                        <p class="text-gray-800 line-clamp-2">{{ photo.caption }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Update the scroll function -->
        <script>
        function scrollToGallery() {
            document.getElementById('fullGallery').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start',
                inline: 'nearest'
            });
        }
        </script>

        <!-- Add animation styles -->
        <style>
        .featured-photo {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Add animation delay for each featured photo */
        .featured-photo:nth-child(1) { animation-delay: 0.2s; }
        .featured-photo:nth-child(2) { animation-delay: 0.4s; }
        .featured-photo:nth-child(3) { animation-delay: 0.6s; }
        </style>
    </div>

    <!-- Modal -->
    <div id="imageModal" class="modal" role="dialog" aria-modal="true">
        <button class="modal-close" onclick="closeModal()" aria-label="Close modal">×</button>
        <div class="image-counter">
            <span id="currentImageNum"></span> / <span id="totalImages"></span>
        </div>
        
        <div class="modal-container">
            <button class="modal-nav modal-prev" onclick="navigateModal(-1)" aria-label="Previous image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </button>
            <button class="modal-nav modal-next" onclick="navigateModal(1)" aria-label="Next image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6" />
                </svg>
            </button>
            
            <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
            <img class="modal-content" id="modalImage" alt="" onclick="toggleZoom(this)">
        </div>

        <button class="modal-info-toggle" onclick="toggleInfo()" aria-label="Toggle information">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
        
        <div class="modal-info">
            <h2 id="modalCaption" class="text-white text-xl mb-3 font-medium"></h2>
            <div id="modalDetails" class="text-gray-300 text-sm"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- Initialize the Map -->
    <script>
        // Create the map and set the initial view
        var map = L.map('map').setView([35.6762, 139.6503], 6);  // Center on Japan

        // Use Stadia Maps tiles for better English labels
        L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Create an array to hold all marker positions
        var markers = [];

        // Initialize the marker cluster group with custom options
        var markerCluster = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true
        });

        // Loop through the photos and add markers to the cluster group
        {% for photo in photos %}
            {% if photo.latitude and photo.longitude %}
                var marker = L.marker([{{ photo.latitude }}, {{ photo.longitude }}]);
                var popupContent = `
                    <div class="custom-popup max-w-sm rounded-lg overflow-hidden shadow-lg bg-white transform transition-transform duration-200 hover:scale-105">
                        <div class="relative">
                            <img src="/static/photos/{{ photo.file_path }}" 
                                 class="w-full h-48 object-cover cursor-pointer hover:opacity-90 transition-opacity duration-200"
                                 onclick='openModal("/static/photos/{{ photo.file_path }}", {{ photo.caption|tojson }}, {{ photo.location_name|tojson }}, {{ photo.date_taken.strftime("%B %d, %Y")|tojson if photo.date_taken else "null" }})'
                                 alt="{{ photo.caption }}">
                            {% if photo.location_name %}
                            <div class="absolute top-2 left-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded-full text-xs">
                                {{ photo.location_name }}
                            </div>
                            {% endif %}
                            {% if photo.date_taken %}
                            <div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded-full text-xs">
                                {{ photo.date_taken.strftime('%B %d, %Y') }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-gray-800 line-clamp-2 hover:line-clamp-none cursor-pointer">
                                {{ photo.caption }}
                            </p>
                            <button onclick='openModal("/static/photos/{{ photo.file_path }}", {{ photo.caption|tojson }}, {{ photo.location_name|tojson }}, {{ photo.date_taken.strftime("%B %d, %Y")|tojson if photo.date_taken else "null" }})'
                                    class="mt-3 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors duration-200">
                                View Full Image
                            </button>
                        </div>
                    </div>
                `;
                
                // Create popup with custom options
                var popup = L.popup({
                    maxWidth: 400,
                    className: 'custom-popup',
                    closeButton: false,
                    autoPan: true,
                    autoPanPadding: [50, 50]
                }).setContent(popupContent);
                
                marker.bindPopup(popup);
                markerCluster.addLayer(marker);
                markers.push([{{ photo.latitude }}, {{ photo.longitude }}]);
            {% endif %}
        {% endfor %}

        // Add the marker cluster group to the map
        map.addLayer(markerCluster);

        // Adjust the map view to fit all markers
        if (markers.length > 0) {
            var bounds = L.latLngBounds(markers);
            map.fitBounds(bounds);
        }
    </script>

    <script>
        let currentPhotoIndex = 0;
        let photos = {{ serialized_photos|tojson|safe }};

        function openModal(imageSrc, caption, location, date) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            const modalDetails = document.getElementById('modalDetails');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            currentPhotoIndex = photos.findIndex(photo => `/static/photos/${photo.file_path}` === imageSrc);
            
            modal.style.display = "block";
            loadingSpinner.style.display = "block";
            
            modalImg.onload = function() {
                loadingSpinner.style.display = "none";
                setTimeout(() => modal.classList.add('show'), 10);
            };
            
            modalImg.src = imageSrc;
            modalImg.alt = caption;
            modalCaption.textContent = caption;
            
            let details = [];
            if (location) details.push(location);
            if (date) details.push(date);
            modalDetails.textContent = details.join(' • ');

            updateImageCounter();
            preloadAdjacentImages();
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = "none";
            }, 300);
        }

        function navigateModal(direction) {
            const newIndex = currentPhotoIndex + direction;
            if (newIndex >= 0 && newIndex < photos.length) {
                const photo = photos[newIndex];
                const imageSrc = `/static/photos/${photo.file_path}`;
                const date = photo.date_taken ? new Date(photo.date_taken).toLocaleDateString() : '';
                openModal(imageSrc, photo.caption, photo.location_name, date);
            }
        }

        function preloadAdjacentImages() {
            [-1, 1].forEach(offset => {
                const index = currentPhotoIndex + offset;
                if (index >= 0 && index < photos.length) {
                    const img = new Image();
                    img.src = `/static/photos/${photos[index].file_path}`;
                }
            });
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('imageModal').style.display === 'block') {
                switch(event.key) {
                    case 'ArrowLeft':
                        navigateModal(-1);
                        break;
                    case 'ArrowRight':
                        navigateModal(1);
                        break;
                    case 'Escape':
                        closeModal();
                        break;
                }
            }
        });

        // Prevent modal from closing when clicking on the image
        document.querySelector('.modal-container').addEventListener('click', function(event) {
            event.stopPropagation();
        });

        function toggleZoom(img) {
            img.classList.toggle('zoomed');
            const infoPanel = document.querySelector('.modal-info');
            const infoToggle = document.querySelector('.modal-info-toggle');
            
            if (img.classList.contains('zoomed')) {
                infoPanel.classList.add('hidden');
                infoToggle.style.opacity = '0';
                infoVisible = false;
            } else {
                infoPanel.classList.remove('hidden');
                infoToggle.style.opacity = '1';
                infoVisible = true;
            }
        }

        function updateImageCounter() {
            document.getElementById('currentImageNum').textContent = currentPhotoIndex + 1;
            document.getElementById('totalImages').textContent = photos.length;
        }

        // Add touch swipe support
        let touchStartX = 0;
        let touchEndX = 0;

        document.querySelector('.modal-container').addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.querySelector('.modal-container').addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const swipeDistance = touchEndX - touchStartX;
            
            if (Math.abs(swipeDistance) > swipeThreshold) {
                if (swipeDistance > 0) {
                    navigateModal(-1); // Swipe right = previous
                } else {
                    navigateModal(1);  // Swipe left = next
                }
            }
        }

        // Add mousewheel navigation
        document.querySelector('.modal-container').addEventListener('wheel', function(e) {
            if (e.deltaY > 0) {
                navigateModal(1);  // Scroll down = next
            } else {
                navigateModal(-1); // Scroll up = previous
            }
        });
    </script>

    <script>
    // Add custom map markers with preview
    function createCustomMarker(photo) {
        return L.marker([photo.latitude, photo.longitude], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: `
                    <div class="relative group">
                        <img src="/static/photos/${photo.file_path}" 
                             class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-lg
                                    transition-transform group-hover:scale-150 z-10">
                        <div class="absolute hidden group-hover:block bg-white p-2 rounded shadow-lg -translate-y-full">
                            <img src="/static/photos/${photo.file_path}" class="w-32 h-32 object-cover">
                            <p class="text-sm mt-1">${photo.caption}</p>
                        </div>
                    </div>
                `
            })
        });
    }

    // Add map timeline slider
    function addTimelineSlider() {
        const dates = photos.map(p => new Date(p.date_taken)).sort();
        const slider = L.control.timelineSlider({
            timelineItems: dates,
            extraChangeMapParams: {
                markers: photos.map(p => ({
                    lat: p.latitude,
                    lng: p.longitude,
                    date: new Date(p.date_taken)
                }))
            }
        });
        slider.addTo(map);
    }
    </script>

    <script>
    // Only initialize filters if they exist
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to the filter elements
        const locationFilter = document.getElementById('locationFilter');
        const sortOrder = document.getElementById('sortOrder');
        const fullGallery = document.getElementById('fullGallery');

        // Only add event listeners if the elements exist
        if (locationFilter && sortOrder) {
            locationFilter.addEventListener('change', updateGallery);
            sortOrder.addEventListener('change', updateGallery);
        }

        // Function to sort and filter photos
        function updateGallery() {
            if (!fullGallery) return;
            
            // Always start with a fresh copy of the original photos from the server
            const originalPhotos = {{ serialized_photos|tojson|safe }};
            let filteredPhotos = [...originalPhotos];  // Start fresh every time
            
            // Apply location filter if a specific location is selected
            if (locationFilter && locationFilter.value !== "") {
                filteredPhotos = filteredPhotos.filter(photo => 
                    photo.location_name === locationFilter.value
                );
            }
            
            // Apply sorting
            if (sortOrder) {
                switch(sortOrder.value) {
                    case 'date-desc':
                        filteredPhotos.sort((a, b) => {
                            if (!a.date_taken) return 1;
                            if (!b.date_taken) return -1;
                            return new Date(b.date_taken) - new Date(a.date_taken);
                        });
                        break;
                    case 'date-asc':
                        filteredPhotos.sort((a, b) => {
                            if (!a.date_taken) return 1;
                            if (!b.date_taken) return -1;
                            return new Date(a.date_taken) - new Date(b.date_taken);
                        });
                        break;
                    case 'location':
                        filteredPhotos.sort((a, b) => {
                            if (!a.location_name) return 1;
                            if (!b.location_name) return -1;
                            return (a.location_name || '').localeCompare(b.location_name || '');
                        });
                        break;
                }
            }
            
            // Update the global photos array to match the new order
            photos = filteredPhotos;
            
            // Update the gallery HTML
            fullGallery.innerHTML = filteredPhotos.map(photo => {
                // Format the date if it exists
                let formattedDate = null;
                if (photo.date_taken) {
                    try {
                        formattedDate = new Date(photo.date_taken).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                    } catch (e) {
                        console.error('Error formatting date:', e);
                    }
                }
                
                return `
                    <div class="group bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                        <div class="relative aspect-[4/3] overflow-hidden">
                            <img class="w-full h-full object-cover transform transition-transform duration-700 group-hover:scale-110" 
                                 src="/static/photos/${photo.file_path}" 
                                 alt="${photo.caption || ''}"
                                 loading="lazy"
                                 onclick="openModal('/static/photos/${photo.file_path}', '${(photo.caption || '').replace(/'/g, "\\'")}', '${(photo.location_name || '').replace(/'/g, "\\'")}', ${formattedDate ? `'${formattedDate}'` : null})"
                            >
                            ${photo.location_name ? `
                            <div class="absolute top-4 left-4 bg-black bg-opacity-75 text-white px-3 py-1 rounded-full text-sm">
                                ${photo.location_name}
                            </div>
                            ` : ''}
                        </div>
                        <div class="p-4">
                            <p class="text-gray-800 line-clamp-2">${photo.caption || ''}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
    });
    </script>

    <script>
    let infoVisible = true;

    function toggleInfo() {
        const infoPanel = document.querySelector('.modal-info');
        const modalImage = document.querySelector('.modal-content');
        infoVisible = !infoVisible;
        
        if (infoVisible) {
            infoPanel.classList.remove('hidden');
            modalImage.classList.remove('info-hidden');
        } else {
            infoPanel.classList.add('hidden');
            modalImage.classList.add('info-hidden');
        }
    }
    </script>
</body>
</html> 